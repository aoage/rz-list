@page "/books"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components
@using Models.Entities
@using Data
@implements IAsyncDisposable
@inject IDbContextFactory<Data.RzListDbContext> DbFactory

@attribute [Authorize(Policy = "RequireBookModerator")]

<PageTitle>Index</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h3" GutterBottom="true">User Books</MudText>

    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" Href="books/create"
        Class="mb-4">
        Create New
    </MudButton>

    <MudDataGrid T="Book" Items="@context.Books" Filterable="true" SortMode="SortMode.Multiple" Dense="true"
        Hover="true" ReadOnly="true">
        <Columns>
            <PropertyColumn Property="x => x.Title" Title="Title" />
            <PropertyColumn Property="x => x.Author" Title="Author" />
            <PropertyColumn Property="x => x.ISBN" Title="ISBN" />
            <PropertyColumn Property="x => x.PublishedDate" Title="Published Date" />
            <PropertyColumn Property="x => x.Description" Title="Description" />
            <PropertyColumn Property="x => x.CharacterCount" Title="Character Count" />
            <PropertyColumn Property="x => x.Genre.ToDisplayString()" Title="Genre" />
            <PropertyColumn Property="x => x.Publisher" Title="Publisher" />
            <PropertyColumn Property="x => x.CoverImageUrl" Title="Cover Image" />
            <PropertyColumn Property="x => x.DateAdded" Title="Date Added" />

            <TemplateColumn Title="Actions" Sortable="false" Filterable="false">
                <CellTemplate>
                    <MudButtonGroup Variant="Variant.Text" Size="Size.Small">
                        <MudButton StartIcon="@Icons.Material.Filled.Edit" Href="@($"books/edit?id={context.Item.Id}")">
                            Edit
                        </MudButton>
                        <MudButton StartIcon="@Icons.Material.Filled.Info"
                            Href="@($"books/details?id={context.Item.Id}")">
                            Details
                        </MudButton>
                        <MudButton StartIcon="@Icons.Material.Filled.Delete" Color="Color.Error"
                            Href="@($"books/delete?id={context.Item.Id}")">
                            Delete
                        </MudButton>
                    </MudButtonGroup>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>
</MudContainer>

@code {
    private RzListDbContext context = default!;

    protected override void OnInitialized()
    {
        context = DbFactory.CreateDbContext();
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}
